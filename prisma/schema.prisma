// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                String                @id @default(cuid())
  parentUserId      String                @map("parent_user_id") // Clerk user ID
  firstName         String                @map("first_name")
  lastName          String                @map("last_name")
  dateOfBirth       DateTime?             @map("date_of_birth")
  avatar            String?               
  isActive          Boolean               @default(true) @map("is_active")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  // Relationships
  progress          StudentProgress[]
  subjectProgress   SubjectProgress[]
  enrollments       StudentEnrollment[]
  learningPlans     LearningPlan[]

  @@index([parentUserId])
  @@map("students")
}

// Tracks the current position for each subject
model SubjectProgress {
  id                    String          @id @default(cuid())
  studentId             String          @map("student_id")
  subject               String          // math, ela, science, humanities
  currentNodeId         String?         @map("current_node_id") // what they should work on next
  updatedAt             DateTime        @updatedAt @map("updated_at")
  createdAt             DateTime        @default(now()) @map("created_at")

  // Relations
  student               Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentNode           CurriculumNode? @relation("CurrentNode", fields: [currentNodeId], references: [id])

  @@unique([studentId, subject])
  @@index([studentId])
  @@map("subject_progress")
}

model StudentProgress {
  id              String                @id @default(cuid())
  studentId       String                @map("student_id")
  nodeId          String                @map("node_id")
  status          ProgressStatus        @default(NOT_STARTED)
  completedAt     DateTime?             @map("completed_at")
  score           Float?                // 0-100 percentage
  timeSpent       Int?                  @map("time_spent") // in minutes
  notes           String?
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  student         Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  curriculumNode  CurriculumNode        @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([studentId, nodeId])
  @@index([studentId])
  @@index([nodeId])
  @@map("student_progress")
}

model StudentEnrollment {
  id              String                @id @default(cuid())
  studentId       String                @map("student_id")
  subject         String
  gradeLevel      String                @map("grade_level")
  startDate       DateTime              @map("start_date")
  endDate         DateTime?             @map("end_date")
  isActive        Boolean               @default(true) @map("is_active")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  student         Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_enrollments")
}

// Simplified to focus on completion tracking
enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model CurriculumNode {
  id           String   @id
  unitTitle    String   @map("unit_title")
  unitNumber   Int      @map("unit_number")
  courseTitle  String   @map("course_title")
  coursePath   String   @map("course_path")
  gradeLevel   String   @map("grade_level")
  subject      String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relationships
  outgoingEdges CurriculumEdge[] @relation("FromNode")
  incomingEdges CurriculumEdge[] @relation("ToNode")
  progress      StudentProgress[]
  
  // Subject progress relationships
  currentFor       SubjectProgress[] @relation("CurrentNode")

  @@map("curriculum_nodes")
}

model CurriculumEdge {
  id               String @id @default(cuid())
  fromNodeId       String @map("from_node_id")
  toNodeId         String @map("to_node_id")
  relationshipType String @map("relationship_type")
  description      String
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  fromNode CurriculumNode @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode   CurriculumNode @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId])
  @@map("curriculum_edges")
}

model LearningPlan {
  id              String                @id @default(cuid())
  studentId       String                @map("student_id")
  title           String
  description     String?
  preferences     String?               // JSON string of parent preferences
  startDate       DateTime              @map("start_date")
  endDate         DateTime              @map("end_date")
  isActive        Boolean               @default(true) @map("is_active")
  aiModel         String                @map("ai_model") // Which AI model was used
  unitIds         String[]              @map("unit_ids") // Simple array of curriculum node IDs
  estimatedHours  Float?                @map("estimated_hours") // Total estimated hours for the year
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  student         Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isActive])
  @@map("learning_plans")
}


