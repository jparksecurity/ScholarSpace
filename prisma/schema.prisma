// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                String                @id @default(cuid())
  parentUserId      String                @map("parent_user_id") // Clerk user ID
  firstName         String                @map("first_name")
  lastName          String                @map("last_name")
  dateOfBirth       DateTime?             @map("date_of_birth")
  avatar            String?               
  isActive          Boolean               @default(true) @map("is_active")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  // Relationships
  subjectProgress   SubjectProgress[]
  learningPlans     LearningPlan[]

  @@index([parentUserId])
  @@map("students")
}

// Subject enum for type safety
enum Subject {
  MATH
  ELA
  SCIENCE
  HUMANITIES
}

// Tracks the current position for each subject
model SubjectProgress {
  id                    String          @id @default(cuid())
  studentId             String          @map("student_id")
  subject               Subject         // Now using enum for type safety
  currentNodeId         String?         @map("current_node_id") // what they should work on next
  updatedAt             DateTime        @updatedAt @map("updated_at")
  createdAt             DateTime        @default(now()) @map("created_at")

  // Relations
  student               Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentNode           CurriculumNode? @relation("CurrentNode", fields: [currentNodeId], references: [id])

  @@unique([studentId, subject])
  @@index([studentId])
  @@map("subject_progress")
}

model CurriculumNode {
  id           String   @id
  unitTitle    String   @map("unit_title")
  unitNumber   Int      @map("unit_number")
  courseTitle  String   @map("course_title")
  coursePath   String   @map("course_path")
  gradeLevel   String   @map("grade_level")
  subject      String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relationships
  outgoingEdges CurriculumEdge[] @relation("FromNode")
  incomingEdges CurriculumEdge[] @relation("ToNode")
  
  // Subject progress relationships
  currentFor       SubjectProgress[] @relation("CurrentNode")

  @@map("curriculum_nodes")
}

model CurriculumEdge {
  id               String @id @default(cuid())
  fromNodeId       String @map("from_node_id")
  toNodeId         String @map("to_node_id")
  relationshipType String @map("relationship_type")
  description      String
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  fromNode CurriculumNode @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode   CurriculumNode @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId])
  @@map("curriculum_edges")
}

model LearningPlan {
  id              String                @id @default(cuid())
  studentId       String                @map("student_id")
  startDate       DateTime              @map("start_date")
  endDate         DateTime              @map("end_date")
  isActive        Boolean               @default(true) @map("is_active")
  unitIds         String[]              @map("unit_ids") // Simple array of curriculum node IDs
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  student         Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isActive])
  @@map("learning_plans")
}


